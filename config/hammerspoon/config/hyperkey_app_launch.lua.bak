-- ==============================================
-- Launch Applications hyperKey + key
-- Define the hyper key (ctrl + shift + option + command)
local hyperKey = {"ctrl", "shift", "option", "command"}
local launcher = require('config.launchers.init')
local utils = require('config.utils')
local feedback = require('config.visual_feedback')

-- Define a table of applications and their corresponding keys
-- You can now specify custom paths for apps not in the default Applications directory
-- OR specify URLs to open in specific browsers
-- Optional: Add bundleID for toggle functionality
local appList = {
    ["f4"] = {app = "WezTerm", path = "/Applications/WezTerm.app", bundleID = "com.github.wez.wezterm"},
	["1"] = {app = "Edge", path = "/Applications/Microsoft Edge.app", bundleID = "com.microsoft.edgemac"},
	["2"] = {app = "Firefox", path = "/Applications/Firefox.app", bundleID = "org.mozilla.firefox"},
    ["3"] = {app = "Teams", path = "/Applications/Microsoft Teams.app", bundleID = "com.microsoft.teams2"},
	["c"] = {app = "Claude", path = "/Applications/Claude.app", bundleID = "com.anthropic.claude"},
    ["g"] = {app = "ChatGPT", path = "/Applications/ChatGPT.app", bundleID = "com.openai.chat"},
	["i"] = {app = "IntelliJ", path = "/Applications/IntelliJ IDEA.app", bundleID = "com.jetbrains.intellij"},
	["n"] = {app = "Notion", path = "/Applications/Notion.app", bundleID = "notion.id"},
    ["o"] = {app = "Outlook", path = "/Applications/Microsoft Outlook.app", bundleID = "com.microsoft.Outlook"},
	["m"] = {app = "Mail", path = "/System/Applications/Mail.app", bundleID = "com.apple.mail"},
	["p"] = {app = "1Password", path = "/Applications/1Password.app", bundleID = "com.1password.1password"},
	["s"] = {app = "Sourcetree", path = "/Applications/Sourcetree.app", bundleID = "com.torusknot.SourceTreeNotMAS"},
	["t"] = {app = "TablePlus", path = "/Applications/TablePlus.app", bundleID = "com.tinyapp.TablePlus"},
	["v"] = {app = "VS Code", path = "/Applications/Visual Studio Code.app", bundleID = "com.microsoft.VSCode"},
	["x"] = {app = "TextMate", path = "/Applications/TextMate.app", bundleID = "com.macromates.TextMate"},
	["w"] = {app = "WhatsApp", path = "/Applications/WhatsApp.app", bundleID = "net.whatsapp.WhatsApp"},
}

-- Function to launch a URL in a specific browser
local function launchURL(url, browser, key, description)
    local browserBundle = {
        ["Firefox"] = "org.mozilla.firefox",
        ["Chrome"] = "com.google.Chrome",
        ["Safari"] = "com.apple.Safari",
        ["Edge"] = "com.microsoft.edgemac"
    }

    local bundleID = browserBundle[browser]
    if not bundleID then
        utils.feedback.showStatus("Unsupported browser: " .. browser .. " (Key: " .. key .. ")")
        return
    end

    -- Use hs.urlevent.openURLWithBundle to open URL in specific browser
    local success = hs.urlevent.openURLWithBundle(url, bundleID)
    if success then
        utils.feedback.showStatus("Opened: " .. (description or url) .. " in " .. browser .. " (Key: " .. key .. ")")
    else
        utils.feedback.showStatus("Failed to open URL in " .. browser .. " (Key: " .. key .. ")")
    end
end

-- Function to cycle through multiple windows of an app
local function cycleAppWindows(key)
    local itemData = appList[key]
    if not itemData then return end

    local success = launcher.cycleAppWindows(itemData)
    if not success then
        -- If cycling failed, try to launch/focus instead
        launcher.launchOrFocus(itemData)
    end
end

-- Function to launch an app with toggle functionality
local function launchApp(key, modifiers)
    print("===== HOTKEY PRESSED: " .. key .. " at " .. os.date("%H:%M:%S"))
    local itemData = appList[key]
    if not itemData then
        utils.feedback.showStatus("No app configured for this key")
        return
    end

    print("===== CALLING launcher.launchOrFocus for: " .. (itemData.app or "unknown"))
    -- Use shared launcher module
    local app, err = launcher.launchOrFocus(itemData)

    print("===== launcher.launchOrFocus returned: " .. tostring(app))
    if not app then
        utils.feedback.showStatus(err or "Failed to launch")
    end
end

-- Enhanced function to handle both apps and URLs
local function handleLaunch(key, itemData)
    if itemData.type == "url" then
        -- Handle URL launch
        launchURL(itemData.url, itemData.browser, key, itemData.description)
    elseif itemData.app or itemData.name or itemData.bundleID or itemData.path then
        -- Handle regular app launch with toggle functionality
        launchApp(key)
    else
        -- Handle error case
        utils.feedback.showStatus("Invalid configuration for key: " .. key)
    end
end

-- Validate configuration at startup
local function validateConfig()
    local errors = {}
    for key, itemData in pairs(appList) do
        if not itemData then
            table.insert(errors, "Key '" .. key .. "' has nil configuration")
        elseif itemData.type == "url" then
            -- Validate URL configuration
            if not itemData.url or itemData.url == "" then
                table.insert(errors, "Key '" .. key .. "' URL type missing url field")
            end
            if not itemData.browser or itemData.browser == "" then
                table.insert(errors, "Key '" .. key .. "' URL type missing browser field")
            end
        else
            -- Validate app configuration
            if not (itemData.app or itemData.name or itemData.bundleID or itemData.path) then
                table.insert(errors, "Key '" .. key .. "' missing app identifier (app/name/bundleID/path)")
            end
        end
    end

    if #errors > 0 then
        local errorMsg = "Hyperkey launcher config errors:\n" .. table.concat(errors, "\n")
        hs.notify.new({title="Config Error", informativeText=errorMsg}):send()
        return false
    end
    return true
end

-- Validate before binding hotkeys
if validateConfig() then
    -- Bind the hotkeys to launch apps/URLs based on the list (using native Hammerspoon hotkeys - more efficient)
    for key, itemData in pairs(appList) do
        hs.hotkey.bind(hyperKey, key, function()
            handleLaunch(key, itemData)
        end)
    end
end

-- Show a notification when Hammerspoon loads, to let you know the script is active (commented to reduce notification spam)
-- hs.notify.new({title="Hammerspoon", informativeText="App launcher script is active!"}):send()
